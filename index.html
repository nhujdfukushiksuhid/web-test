<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ”¯æ´è¨ˆç”»çµ±åˆã‚·ã‚¹ãƒ†ãƒ  - Ver.13.0 Deadline-Alert</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* * ==========================================================================
         * Design System: Integrated Warmth (Orange & Green)
         * ==========================================================================
         */
        :root {
            --primary: #f97316;
            --primary-dark: #c2410c;
            --primary-light: #fff7ed;
            --secondary: #10b981;
            --secondary-dark: #047857;
            --secondary-light: #ecfdf5;
            --tertiary: #6366f1;
            --tertiary-dark: #4f46e5;
            --bg-body: #f8fafc;
            --surface: #ffffff;
            --text-main: #334155;
            --text-muted: #64748b;
            --border: #cbd5e1;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --danger: #ef4444;
        }

        /* --- Reset & Base --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0;
            line-height: 1.6;
            padding-bottom: 40px;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* --- Header Section --- */
        header { text-align: center; margin-bottom: 30px; padding: 20px 0; }
        h1 {
            font-size: 2rem; color: var(--text-main); margin: 0 0 10px 0;
            display: inline-flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: center;
        }
        .tag-ver {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; font-size: 0.8rem; padding: 4px 12px; border-radius: 99px;
            vertical-align: middle; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .subtitle { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 20px; }

        .security-alert {
            background-color: var(--secondary-light);
            border: 2px solid var(--secondary);
            color: var(--secondary-dark);
            display: inline-flex; align-items: center; gap: 8px;
            padding: 8px 24px; border-radius: 50px;
            font-weight: bold; font-size: 0.9rem;
        }

        /* --- ALERT WINDOW (NEW) --- */
        .alert-window {
            position: fixed; top: 20px; right: 20px; width: 300px;
            background: white; border-radius: var(--radius);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 9000; overflow: hidden;
            display: none; /* Hidden by default */
            animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid var(--border);
        }
        .alert-window.active { display: block; }
        
        .alert-header {
            background: #333; color: white; padding: 12px 16px;
            font-weight: bold; display: flex; justify-content: space-between; align-items: center;
        }
        .alert-body {
            max-height: 300px; overflow-y: auto; padding: 0;
        }
        .alert-item {
            padding: 12px 16px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9rem;
        }
        .alert-item:last-child { border-bottom: none; }
        
        /* Urgency Levels */
        .urgency-overdue { background: #fee2e2; border-left: 5px solid #dc2626; animation: flash 2s infinite; }
        .urgency-danger { background: #fff1f2; border-left: 5px solid #e11d48; } /* < 1 month */
        .urgency-warning { background: #fff7ed; border-left: 5px solid #f97316; } /* < 2 months */
        .urgency-info { background: #eff6ff; border-left: 5px solid #3b82f6; }    /* < 3 months */

        .days-left { font-weight: bold; font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.8); }
        
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
        @keyframes flash { 0%, 100% { background-color: #fee2e2; } 50% { background-color: #fca5a5; } }

        /* --- Mode Switcher --- */
        .mode-tabs {
            display: flex; justify-content: center; gap: 20px; margin-bottom: 40px;
        }
        .mode-tab {
            padding: 16px 32px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            background: var(--surface);
            color: var(--text-muted);
            border: 2px solid var(--border);
            transition: all 0.3s ease;
            display: flex; align-items: center; gap: 10px;
            box-shadow: var(--shadow);
        }
        .mode-tab:hover { transform: translateY(-2px); }
        .mode-tab.active[data-mode="ai"] { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 8px 16px rgba(249, 115, 22, 0.4); }
        .mode-tab.active[data-mode="db"] { background: var(--secondary); color: white; border-color: var(--secondary); box-shadow: 0 8px 16px rgba(16, 185, 129, 0.4); }

        /* --- Views --- */
        .view-section { display: none; animation: fadeIn 0.4s ease-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI Components --- */
        .drop-wrapper { background: var(--surface); padding: 10px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 30px; }
        .drop-zone { border: 3px dashed var(--border); border-radius: 8px; padding: 40px 20px; background: #f8fafc; cursor: pointer; text-align: center; transition: all 0.3s ease; }
        .drop-zone:hover, .drop-zone.dragover { transform: scale(1.005); }
        .drop-zone.ai-theme:hover, .drop-zone.ai-theme.dragover { border-color: var(--primary); background: var(--primary-light); }
        .drop-zone.db-theme:hover, .drop-zone.db-theme.dragover { border-color: var(--secondary); background: var(--secondary-light); }
        .drop-title { font-size: 1.3rem; font-weight: bold; color: var(--text-main); margin-bottom: 8px; }

        .logic-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .logic-card { background: var(--surface); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; overflow: hidden; }
        .logic-card::before { content: ''; position: absolute; top:0; left:0; width:6px; height:100%; background: var(--primary); }
        .logic-title { font-weight: bold; font-size: 1.05rem; margin-bottom: 6px; color: var(--text-main); }
        .logic-desc { font-size: 0.85rem; color: var(--text-muted); }

        button { border: none; padding: 10px 20px; border-radius: 50px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; font-size: 0.95rem; }
        .btn-ai { background: var(--primary); color: white; } .btn-ai:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-db { background: var(--secondary); color: white; } .btn-db:hover { background: var(--secondary-dark); transform: translateY(-2px); }
        .btn-merge { background: var(--tertiary); color: white; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4); } .btn-merge:hover { background: var(--tertiary-dark); transform: translateY(-2px); }
        .btn-sub { background: white; border: 2px solid var(--border); color: var(--text-main); } .btn-sub:hover { background: var(--bg-body); }
        .btn-danger { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; } .btn-danger:hover { background: #fecaca; }

        .table-wrap { overflow-x: auto; background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; white-space: normal; }
        th { background: #f1f5f9; padding: 14px; text-align: left; font-weight: bold; color: var(--text-main); border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 10; font-size: 0.9rem; }
        td { padding: 14px; border-bottom: 1px solid var(--border); vertical-align: top; font-size: 0.9rem; }
        .col-life { background-color: #fffbeb; } .col-work { background-color: #f0fdf4; } .col-future { background-color: #eff6ff; }

        .db-controls { background: var(--surface); padding: 16px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 12px; justify-content: space-between; align-items: center; }
        .search-box { flex-grow: 1; max-width: 400px; position: relative; }
        .search-input { width: 100%; padding: 12px 16px 12px 40px; border-radius: 50px; border: 1px solid var(--border); font-size: 1rem; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        .list-item { background: var(--surface); padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; cursor: pointer; transition: background 0.1s; }
        .list-item:hover { background: #f8fafc; }
        .list-id-badge { background: var(--secondary-light); color: var(--secondary-dark); font-weight: bold; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 12px; }
        .list-content { flex-grow: 1; }
        .list-name { font-weight: bold; font-size: 1.05rem; display: block; }
        .list-meta { font-size: 0.85rem; color: var(--text-muted); }
        .action-area { display: flex; gap: 8px; align-items: center; }
        .btn-delete { background: transparent; color: #ccc; border: 1px solid #eee; padding: 8px; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
        .btn-delete:hover { background: #fee2e2; color: var(--danger); border-color: #fecaca; }

        .form-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .form-modal.active { opacity: 1; pointer-events: auto; }
        .form-container { background: var(--surface); width: 95%; max-width: 800px; height: 90vh; border-radius: var(--radius); display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .form-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fafafa; border-radius: var(--radius) var(--radius) 0 0; }
        .form-body { flex-grow: 1; overflow-y: auto; padding: 30px; }
        .form-footer { padding: 20px; border-top: 1px solid var(--border); background: #fafafa; border-radius: 0 0 var(--radius) var(--radius); display: flex; justify-content: flex-end; gap: 12px; }
        .form-group { margin-bottom: 24px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-main); }
        label.required::after { content: "å¿…é ˆ"; background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; background: #fff; transition: border-color 0.2s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--secondary); }
        textarea { height: 100px; resize: vertical; }

        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 800; color: white; margin-right: 4px; }
        .badge-A { background: #3b82f6; } .badge-B { background: #ef4444; } .badge-C { background: #f59e0b; } .badge-D { background: #10b981; }
        .badge-high { background: #10b981; } .badge-low { background: #f59e0b; }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 64px; height: 64px; background: var(--secondary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); cursor: pointer; z-index: 100; transition: transform 0.2s; }
        .fab:hover { transform: scale(1.1); }

        .hidden { display: none; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #333; color: white; padding: 12px 24px; border-radius: 30px; font-size: 14px; z-index: 3000; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
        .toast.show { transform: translateX(-50%) translateY(0); } .toast.success { background: var(--secondary); } .toast.error { background: var(--danger); }
        .overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .overlay.active { opacity: 1; pointer-events: auto; }
        .spinner { width: 50px; height: 50px; border: 5px solid #eee; border-top-color: var(--secondary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>
    <h1>ğŸŒ± æ”¯æ´è¨ˆç”»çµ±åˆã‚·ã‚¹ãƒ†ãƒ  <span class="tag-ver">Ver.13.0 Deadline-Alert</span></h1>
    <p class="subtitle">å¯å¤‰ãƒ‡ãƒ¼ã‚¿ç”ŸæˆAI ã¨ å›ºå®šãƒ‡ãƒ¼ã‚¿å°å¸³ç®¡ç† ã‚’ã²ã¨ã¤ã«ã€‚</p>
    <div class="security-alert">
        <span>ğŸ”’</span>
        <span>å®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†ï¼šãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨é€ä¿¡ã•ã‚Œãšã€ã‚ãªãŸã®PCå†…ã§å®Œçµã—ã¾ã™</span>
    </div>
</header>

<div id="deadlineAlert" class="alert-window">
    <div class="alert-header">
        <span>âš ï¸ æœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆ</span>
        <span onclick="AlertManager.toggle()" style="cursor:pointer; font-size:12px;">â–¼</span>
    </div>
    <div class="alert-body" id="alertList">
        </div>
</div>

<div class="container">
    <div class="mode-tabs">
        <div class="mode-tab active" data-mode="ai" onclick="App.switchMode('ai')">
            <span>ğŸ¤–</span> AIè‡ªå‹•ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ (å¯å¤‰)
        </div>
        <div class="mode-tab" data-mode="db" onclick="App.switchMode('db')">
            <span>ğŸ—‚ï¸</span> å°å¸³ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ (å›ºå®š)
        </div>
    </div>

    <div id="view-ai" class="view-section active">
        <div class="logic-grid">
            <div class="logic-card">
                <div class="logic-title">ğŸ“Š ãƒã‚¸ãƒã‚¬åˆ†æ</div>
                <div class="logic-desc">æ—¥å ±ã‹ã‚‰çŠ¶æ…‹ã‚’åˆ†æã—ã€ã§ãã¦ã„ã‚‹äººã«ã¯ã€Œä¼¸ã°ã™ã€ã€èª²é¡ŒãŒã‚ã‚‹äººã«ã¯ã€Œæ”¯ãˆã‚‹ã€ææ¡ˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚</div>
            </div>
            <div class="logic-card">
                <div class="logic-title">ğŸ° å…¨é …ç›®ã‚¹ãƒ­ãƒƒãƒˆç”Ÿæˆ</div>
                <div class="logic-desc">Excelã‚’ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ãŸã³ã€æ•°åƒãƒ‘ã‚¿ãƒ¼ãƒ³ã®çµ„ã¿åˆã‚ã›ã‹ã‚‰ã€Œã‹ã¶ã‚Šãªã—ã€ã®æ–‡ç« ã‚’å¯å¤‰çš„ã«ç”Ÿæˆã—ã¾ã™ã€‚</div>
            </div>
        </div>

        <div class="drop-wrapper">
            <div id="dropZoneAI" class="drop-zone ai-theme">
                <div class="drop-title">AIç”Ÿæˆç”¨: Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°</div>
                <div style="color:var(--text-muted);">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ (.xlsx)</div>
                <input type="file" id="fileInputAI" accept=".xlsx, .xls" style="display:none">
            </div>
        </div>

        <div id="aiResultArea" class="hidden">
            <div class="db-controls" style="justify-content: flex-end;">
                <div style="margin-right:auto; font-weight:bold;">ç”Ÿæˆå®Œäº†: <span id="aiCountDisplay">0</span> å</div>
                <button class="btn-sub" id="aiRetryBtn">ğŸ² å…¨å“¡æ›¸ãç›´ã™</button>
                <button class="btn-sub" id="aiCopyBtn">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                <button class="btn-ai" id="aiDownloadBtn">ğŸ’¾ AIç”Ÿæˆã®ã¿CSV</button>
                <button class="btn-merge" id="aiMergeBtn">âš¡ å°å¸³çµ±åˆCSVå‡ºåŠ›</button>
            </div>
            <div class="table-wrap">
                <table id="aiResultTable">
                    <thead>
                        <tr>
                            <th style="min-width:140px;">å¯¾è±¡è€…å</th>
                            <th style="min-width:120px;">åˆ†æçµæœ</th>
                            <th style="min-width:320px;">ç·åˆçš„ãªæ”¯æ´æ–¹é‡</th>
                            <th style="min-width:280px;">é•·æœŸç›®æ¨™</th>
                            <th style="min-width:280px;">çŸ­æœŸç›®æ¨™</th>
                            <th style="min-width:260px;" class="col-life">ç›®æ¨™1 (ç”Ÿæ´»)</th>
                            <th style="min-width:260px;" class="col-life">æ”¯æ´1</th>
                            <th style="min-width:260px;" class="col-work">ç›®æ¨™2 (ä½œæ¥­)</th>
                            <th style="min-width:260px;" class="col-work">æ”¯æ´2</th>
                            <th style="min-width:260px;" class="col-future">ç›®æ¨™3 (å°±åŠ´)</th>
                            <th style="min-width:260px;" class="col-future">æ”¯æ´3</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-db" class="view-section">
        <div class="drop-wrapper" style="border-color:var(--secondary);">
            <div id="dropZoneDB" class="drop-zone db-theme">
                <div class="drop-title" style="color:var(--secondary-dark);">ğŸ—‚ï¸ å°å¸³ç™»éŒ²ç”¨: åˆ©ç”¨è€…å…¨å“¡ã®Excelã‚’ãƒ‰ãƒ©ãƒƒã‚°</div>
                <div style="color:var(--text-muted);">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆCSVã‚’ä½¿ã†ã¨ä¸€æ‹¬ç™»éŒ²ã§ãã¾ã™</div>
                <input type="file" id="fileInputDB" accept=".xlsx, .xls, .csv" style="display:none">
            </div>
        </div>

        <div class="db-controls">
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="dbSearchInput" class="search-input" placeholder="åå‰ã‚„IDã§æ¤œç´¢..." onkeyup="DBManager.filterList()">
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn-sub" onclick="DBManager.downloadTemplate()">
                    <span>ğŸ“¥</span> ãƒ‡ãƒ¼ã‚¿ç·¨é›†ç”¨CSV (ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ)
                </button>
                <button class="btn-db" onclick="DBManager.exportCSV()">
                    <span>ğŸ’¾</span> å°å¸³ãƒ‡ãƒ¼ã‚¿ã‚’CSVä¿å­˜
                </button>
                <button class="btn-danger" onclick="DBManager.deleteAll()">
                    <span>ğŸ—‘ï¸</span> å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
                </button>
            </div>
        </div>

        <div id="db-list-container"></div>
        <div class="fab" onclick="DBManager.openForm()" title="æ–°è¦ç™»éŒ²">ï¼‹</div>
    </div>
</div>

<div id="formModal" class="form-modal">
    <div class="form-container">
        <div class="form-header">
            <h2 style="margin:0; color:var(--text-main);">âœï¸ åˆ©ç”¨è€…ãƒ‡ãƒ¼ã‚¿ç·¨é›† (å›ºå®š)</h2>
            <button class="btn-sub" onclick="DBManager.closeForm()" style="padding:4px 12px;">âœ•</button>
        </div>
        <div class="form-body">
            <form id="dbForm"><div id="dynamic-form-fields"></div></form>
        </div>
        <div class="form-footer">
            <button type="button" class="btn-sub" onclick="DBManager.closeForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button type="button" class="btn-db" onclick="DBManager.saveForm()">ä¿ å­˜ ã™ ã‚‹</button>
        </div>
    </div>
</div>

<div id="loadingOverlay" class="overlay">
    <div class="spinner"></div>
    <h3 id="loadingText" style="margin-top:20px; color:var(--text-main);">å‡¦ç†ä¸­...</h3>
</div>

<div id="toast" class="toast">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>

<script>
/**
 * SHARED UTILITIES
 */
const Utils = {
    showToast(msg, type = "success") {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.className = `toast show ${type}`;
        setTimeout(() => toast.classList.remove("show"), 3000);
    },
    escapeCSV(text) {
        if (text === null || text === undefined) return "";
        let str = String(text);
        if (/^[=+\-@]/.test(str)) str = "'" + str;
        if (/[",\n\r]/.test(str)) return `"${str.replace(/"/g, '""')}"`;
        return str;
    },
    downloadCSV(filename, content) {
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const blob = new Blob([bom, content], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    },
    toJapaneseDate(isoDateStr) {
        if (!isoDateStr) return "";
        const d = new Date(isoDateStr);
        if (isNaN(d.getTime())) return isoDateStr;
        const y = d.getFullYear();
        const m = d.getMonth() + 1;
        const day = d.getDate();
        let era = "", waYear = y;
        const ymd = y * 10000 + m * 100 + day;
        if (ymd >= 20190501) { era = "ä»¤å’Œ"; waYear = y - 2018; }
        else if (ymd >= 19890108) { era = "å¹³æˆ"; waYear = y - 1988; }
        else if (ymd >= 19261225) { era = "æ˜­å’Œ"; waYear = y - 1925; }
        else if (ymd >= 19120730) { era = "å¤§æ­£"; waYear = y - 1911; }
        else { era = "æ˜æ²»"; waYear = y - 1868; }
        if (waYear === 1) waYear = "å…ƒ";
        return `${era}${waYear}å¹´${m}æœˆ${day}æ—¥`;
    }
};

/**
 * ALERT MANAGER (NEW)
 */
const AlertManager = {
    checkDeadlines(members) {
        const container = document.getElementById("alertList");
        const windowEl = document.getElementById("deadlineAlert");
        container.innerHTML = "";
        let hasAlert = false;
        
        const now = new Date();
        
        members.forEach(m => {
            if (!m.prev_plan_date) return;
            const prevDate = new Date(m.prev_plan_date);
            if (isNaN(prevDate.getTime())) return;

            // æœŸé™ = å‰å›ä½œæˆæ—¥ + 6ãƒ¶æœˆ
            const deadline = new Date(prevDate);
            deadline.setMonth(deadline.getMonth() + 6);
            
            // æ®‹ã‚Šæ—¥æ•°
            const diffTime = deadline - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let urgencyClass = "";
            let message = "";

            if (diffDays < 0) {
                urgencyClass = "urgency-overdue";
                message = `æœŸé™åˆ‡ã‚Œ (${Math.abs(diffDays)}æ—¥è¶…é)`;
                hasAlert = true;
            } else if (diffDays <= 30) {
                urgencyClass = "urgency-danger";
                message = `æ®‹ã‚Š ${diffDays}æ—¥`;
                hasAlert = true;
            } else if (diffDays <= 60) {
                urgencyClass = "urgency-warning";
                message = `æ®‹ã‚Š ${diffDays}æ—¥`;
                hasAlert = true;
            } else if (diffDays <= 90) {
                urgencyClass = "urgency-info";
                message = `æ®‹ã‚Š ${diffDays}æ—¥`;
                hasAlert = true;
            }

            if (urgencyClass) {
                const item = document.createElement("div");
                item.className = `alert-item ${urgencyClass}`;
                item.innerHTML = `
                    <span style="font-weight:bold;">${m.name}</span>
                    <span class="days-left">${message}</span>
                `;
                container.appendChild(item);
            }
        });

        if (hasAlert) {
            windowEl.classList.add("active");
        } else {
            windowEl.classList.remove("active");
        }
    },
    toggle() {
        const list = document.getElementById("alertList");
        list.style.display = list.style.display === "none" ? "block" : "none";
    }
};

/**
 * AI ENGINE (Variable Data)
 */
const AIEngine = {
    lastWorkbook: null,
    generatedHistory: new Set(),
    currentGeneratedData: [], 
    KEYWORDS: {
        types: { A: ['PC','å…¥åŠ›','å°±è·','ä»•äº‹','ã‚¹ã‚­ãƒ«','è³‡æ ¼','å®Ÿç¿’','æ±‚äºº','Word','Excel'], B: ['ä½“èª¿','ç—…é™¢','è–¬','ä¼‘ã¿','é…åˆ»','ä¸èª¿','é€šé™¢','ä¸å®‰','ã—ã‚“ã©ã„','çœ æ°—'], C: ['ä¼šè©±','ãƒˆãƒ©ãƒ–ãƒ«','æ€’','å£°','ç›¸è«‡','æ„Ÿæƒ…','ä»–å®³','ã‚¤ãƒ©ã‚¤ãƒ©','å–§å˜©'], D: ['æœ','æŒ¨æ‹¶','å¿˜ã‚Œ','ç‰‡ä»˜ã‘','æƒé™¤','ãƒ«ãƒ¼ãƒ«','é¢¨å‘‚','æ­¯ç£¨ã','é‡‘éŠ­'] },
        sentiment: { positive: ['ã§ããŸ','å®‰å®š','è‰¯å¥½','æ„æ¬²','ç¬‘é¡”','é›†ä¸­','é †èª¿','å•é¡Œãªã','ä¸å¯§','æ—©ã„','æ­£ç¢º','å‚åŠ ','æ¥½ã—','çš†å‹¤'], negative: ['ä¼‘ã¿','é…åˆ»','æ—©é€€','ä¸èª¿','ãƒˆãƒ©ãƒ–ãƒ«','èˆˆå¥®','æ‹’å¦','å¿˜ã‚Œ','ãƒŸã‚¹','æ³¨æ„','ä¸­æ–­','å¸°å®…','åœæ­¢','ä¸å®‰å®š'] }
    },
    VOCAB: {
        openers: ["ã¾ãšã¯", "æ—¥ã€…ã®æ´»å‹•ã‚’é€šã˜ã¦", "æœ¬äººã®ãƒšãƒ¼ã‚¹ã‚’å¤§åˆ‡ã«ã—", "ç¾åœ¨ã®çŠ¶æ³ã‚’è¸ã¾ãˆ", "å°†æ¥çš„ãªå±•æœ›ã‚’è¦‹æ®ãˆ", "ã”æœ¬äººã®æ„å‘ã‚’å°Šé‡ã—", "ç’°å¢ƒã®å¤‰åŒ–ã«åˆã‚ã›", "æœ¬äººã®å¼·ã¿ã‚’æ´»ã‹ã™ãŸã‚", "é•·æœŸçš„ãªè¦–ç‚¹ã«ç«‹ã¡", "æ—¥é ƒã®æ§˜å­ã‹ã‚‰", "å®‰å®šã—ãŸåŸºç›¤ã®ä¸Šã§", "è‡ªä¿¡ã‚’è‚²ã‚€ãŸã‚ã«", "ç€å®Ÿãªã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦"],
        modifiers: { high: ["å¼•ãç¶šã", "å®‰å®šã—ã¦", "ä¸»ä½“çš„ã«", "è‡ªä¿¡ã‚’æŒã£ã¦", "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’ç™ºæ®ã—", "ã•ã‚‰ã«", "é«˜ã„æ„è­˜ã§", "ç©æ¥µçš„ã«"], low: ["å°‘ã—ãšã¤", "ç€å®Ÿã«", "ç„¦ã‚‰ãš", "æ®µéšçš„ã«", "æ”¯æ´å“¡ã¨å…±ã«", "ã¾ãšã¯", "ä¸å¯§ã«", "ç„¡ç†ãªã"] },
        policy: { high: ["{opener}ã€ç¾åœ¨ã®è‰¯å¥½ãªçŠ¶æ…‹ã‚’{mod}ç¶­æŒã—ã¤ã¤ã€ã•ã‚‰ãªã‚‹ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã‚’ç›®æŒ‡ã™ã€‚", "{mod}æ´»å‹•ã§ãã¦ã„ã‚‹å¼·ã¿ã‚’æ´»ã‹ã—ã€{focus}ã¸ã®æŒ‘æˆ¦ã‚’å¾ŒæŠ¼ã—ã™ã‚‹ã€‚", "{opener}ã€æœ¬äººã®ä¸»ä½“æ€§ã‚’å°Šé‡ã—ã€{mod}æ´»å‹•ã®å¹…ã‚’åºƒã’ã¦ã„ã‘ã‚‹ã‚ˆã†æ”¯æ´ã™ã‚‹ã€‚", "å®‰å®šã—ãŸç”Ÿæ´»ãƒªã‚ºãƒ ã‚’åŸºç›¤ã«ã€{focus}ã«å‘ã‘ãŸå–ã‚Šçµ„ã¿ã‚’{mod}é€²ã‚ã‚‹ã€‚"], low: ["{opener}ã€å¿ƒèº«ã®å®‰å®šã‚’æœ€å„ªå…ˆã¨ã—ã€{mod}ç”Ÿæ´»ãƒªã‚ºãƒ ã‚’æ•´ãˆã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ã‚‹ã€‚", "èª²é¡Œã¨ãªã£ã¦ã„ã‚‹ç‚¹ã«å¯¾ã—ã€{mod}å‘ãåˆãˆã‚‹ã‚ˆã†ã€æ‰‹åšã„ã‚µãƒãƒ¼ãƒˆã‚’è¡Œã†ã€‚", "{opener}ã€å®‰å¿ƒã—ã¦éã”ã›ã‚‹ç’°å¢ƒã‚’æ•´ãˆã€{mod}æ´»å‹•ã«å‚åŠ ã§ãã‚‹ã‚ˆã†æ”¯æ´ã™ã‚‹ã€‚", "ã¾ãšã¯{mod}ä¿¡é ¼é–¢ä¿‚ã‚’æ§‹ç¯‰ã—ã€å›°ã‚Šã”ã¨ã‚’ç›¸è«‡ã§ãã‚‹ä½“åˆ¶ã‚’ä½œã‚‹ã€‚"], focus: { A: "å°±åŠ´ã«å‘ã‘ãŸå®Ÿè·µçš„ãªã‚¹ã‚­ãƒ«ç¿’å¾—", B: "å¿ƒèº«ã®å¥åº·ç®¡ç†ã¨è‡ªå·±ç†è§£", C: "å††æ»‘ãªå¯¾äººé–¢ä¿‚ã®æ§‹ç¯‰", D: "è‡ªç«‹ã—ãŸæ—¥å¸¸ç”Ÿæ´»ã®ç¢ºç«‹" } },
        long_goal: { high: ["{mod}ç¤¾ä¼šç”Ÿæ´»ã‚’é€ã‚Šã€{focus}ã‚’å®Ÿç¾ã™ã‚‹ã€‚", "è‡ªèº«ã®å¼·ã¿ã‚’æ´»ã‹ã—ã€{focus}çŠ¶æ…‹ã§æ´»èºã™ã‚‹ã€‚", "å‘¨å›²ã‹ã‚‰ä¿¡é ¼ã•ã‚Œã€{mod}{focus}ã§ãã‚‹ã€‚", "è‡ªå·±å®Ÿç¾ã«å‘ã‘ã€{mod}ã‚­ãƒ£ãƒªã‚¢ã‚’ç©ã¿é‡ã­ã‚‹ã€‚"], low: ["å¿ƒèº«å…±ã«å®‰å®šã—ã€{focus}ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚", "è‡ªèº«ã®èª²é¡Œã‚’ç†è§£ã—ã€{mod}å¯¾å‡¦ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚", "æ”¯æ´ã‚’å—ã‘ãªãŒã‚‰ã€{mod}{focus}ç”Ÿæ´»ã‚’é€ã‚‹ã€‚", "å®‰å¿ƒã—ã¦åœ°åŸŸã§æš®ã‚‰ã™ãŸã‚ã®{focus}ã‚’èº«ã«ã¤ã‘ã‚‹ã€‚"], focus: { A: "ä¸€èˆ¬å°±åŠ´", B: "å¥åº·çš„ãªç”Ÿæ´»", C: "ç©ã‚„ã‹ãªäººé–“é–¢ä¿‚", D: "è‡ªç«‹ã—ãŸç”Ÿæ´»" } },
        short_goal: { high: ["æ—¥ã€…ã®æ´»å‹•ã®ä¸­ã§ã€{mod}ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’ç™ºæ®ã™ã‚‹ã€‚", "æ–°ã—ã„èª²é¡Œã«ã‚‚{mod}æŒ‘æˆ¦ã—ã€çµŒé¨“ã‚’ç©ã‚€ã€‚", "è‡ªèº«ã®ä½“èª¿ã‚„æ„Ÿæƒ…ã‚’{mod}ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã—ã€ç¶­æŒã™ã‚‹ã€‚", "å‘¨å›²ã®æ‰‹æœ¬ã¨ãªã‚‹ã‚ˆã†ãªè¡Œå‹•ã‚’{mod}å¿ƒãŒã‘ã‚‹ã€‚"], low: ["ã¾ãšã¯{mod}é€šæ‰€ã—ã€ç”Ÿæ´»ã®ãƒªã‚ºãƒ ã‚’ä½œã‚‹ã€‚", "å›°ã£ãŸæ™‚ã«ã¯{mod}ç›¸è«‡ã—ã€è§£æ±ºç­–ã‚’ä¸€ç·’ã«è€ƒãˆã‚‹ã€‚", "åŸºæœ¬çš„ãªãƒ«ãƒ¼ãƒ«ã‚’{mod}ç†è§£ã—ã€å®ˆã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚", "ã‚¹ã‚¿ãƒƒãƒ•ã®åŠ©è¨€ã‚’å—ã‘å…¥ã‚Œã€{mod}ä½œæ¥­ã«å–ã‚Šçµ„ã‚€ã€‚"] },
        contents: { life: { topic: ["èº«ã ã—ãªã¿ã®ä¿æŒ", "è¨ˆç”»çš„ãªé‡‘éŠ­ç®¡ç†", "è‡ªç™ºçš„ãªæŒ¨æ‹¶", "ç”Ÿæ´»ãƒªã‚ºãƒ ã®ç¶­æŒ", "ç¢ºå®Ÿãªæœè–¬ç®¡ç†", "æ•´ç†æ•´é “ã®å¾¹åº•", "æ„ŸæŸ“å¯¾ç­–ã®å®Ÿæ–½"], sup: ["ãƒã‚§ãƒƒã‚¯è¡¨ã§ã®ç¢ºèª", "å‡ºç´å¸³ã®è¨˜å…¥è£œåŠ©", "ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã®å®Ÿæ–½", "ãƒªã‚ºãƒ è¡¨ã®ç¢ºèª", "é€šé™¢åŒè¡Œ", "æœè–¬ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç¢ºèª", "å£°æ›ã‘"] }, work: { topic: ["ä½œæ¥­æ‰‹é †ã®éµå®ˆ", "é›†ä¸­åŠ›ã®æŒç¶š", "è‡ªç™ºçš„ãªå ±é€£ç›¸", "ä¸æ˜ç‚¹ã®è³ªå•", "ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯", "å¾Œç‰‡ä»˜ã‘ã®å¾¹åº•", "ç´æœŸæ„è­˜", "ä¸å¯§ãªè¨€è‘‰é£ã„"], sup: ["æ‰‹é †æ›¸ã®æç¤º", "åº§å¸­é…ç½®ã®èª¿æ•´", "ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®åŠ©è¨€", "è³ªå•ã—ã‚„ã™ã„ç’°å¢ƒä½œã‚Š", "ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæ´»ç”¨", "ã‚¿ã‚¤ãƒãƒ¼æ”¯æ´", "SSTå®Ÿæ–½"] }, future: { topic: ["æ–½è¨­å¤–å°±åŠ´ã§ã®çµŒé¨“", "æ±‚äººæ¤œç´¢", "PCã‚¹ã‚­ãƒ«ã®å‘ä¸Š", "è³‡æ ¼å–å¾—ã¸ã®æŒ‘æˆ¦", "å¿œå‹Ÿæ›¸é¡ã®ä½œæˆ", "é¢æ¥ç·´ç¿’", "ä¼æ¥­å®Ÿç¿’ã¸ã®å‚åŠ "], sup: ["åŒè¡Œæ”¯æ´", "æ¤œç´¢æ©Ÿæ“ä½œè£œåŠ©", "å¿œç”¨èª²é¡Œã®æä¾›", "å­¦ç¿’è¨ˆç”»ç­–å®š", "æ·»å‰ŠæŒ‡å°", "æ¨¡æ“¬é¢æ¥", "å®Ÿç¿’å…ˆèª¿æ•´"] } },
        endings: { goal_high: ["ç¶­æŒã™ã‚‹ã€‚", "å‘ä¸Šã•ã›ã‚‹ã€‚", "ç›®æŒ‡ã™ã€‚", "åºƒã’ã¦ã„ãã€‚", "ç¢ºç«‹ã™ã‚‹ã€‚", "ç™ºæ®ã™ã‚‹ã€‚"], goal_low: ["èº«ã«ã¤ã‘ã‚‹ã€‚", "ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚", "ç›®æŒ‡ã™ã€‚", "ç¿’æ…£åŒ–ã™ã‚‹ã€‚", "å–ã‚Šçµ„ã‚€ã€‚", "æ„è­˜ã™ã‚‹ã€‚"], sup_high: ["è©•ä¾¡ã—è‡ªä¿¡ã«ç¹‹ã’ã‚‹ã€‚", "æ›´ãªã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ä¿ƒã™ã€‚", "ç’°å¢ƒã‚’æ•´ãˆè¦‹å®ˆã‚‹ã€‚", "æœ¬äººã®è‡ªä¸»æ€§ã«ä»»ã›ã‚‹ã€‚"], sup_low: ["æ‰‹åšãã‚µãƒãƒ¼ãƒˆã™ã‚‹ã€‚", "å…·ä½“çš„ã«åŠ©è¨€ã™ã‚‹ã€‚", "ä¸€ç·’ã«ç¢ºèªã‚’è¡Œã†ã€‚", "ç¹°ã‚Šè¿”ã—å£°æ›ã‘ã‚’è¡Œã†ã€‚", "ç’°å¢ƒèª¿æ•´ã‚’è¡Œã†ã€‚"] }
    },

    init() {
        const dropZone = document.getElementById('dropZoneAI');
        const fileInput = document.getElementById('fileInputAI');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            dropZone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
        });
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => this.handleDrop(e));
        fileInput.addEventListener('change', (e) => { if(e.target.files[0]) this.handleFile(e.target.files[0]); });

        document.getElementById('aiRetryBtn').addEventListener('click', () => { if(this.lastWorkbook) this.renderTable(this.lastWorkbook); });
        document.getElementById('aiCopyBtn').addEventListener('click', () => this.copyToClipboard());
        document.getElementById('aiDownloadBtn').addEventListener('click', () => this.download());
        document.getElementById('aiMergeBtn').addEventListener('click', () => this.downloadMergedCSV());
    },

    handleDrop(e) {
        document.getElementById('dropZoneAI').classList.remove('dragover');
        if (e.dataTransfer.files[0]) this.handleFile(e.dataTransfer.files[0]);
    },

    async handleFile(file) {
        App.showLoading("AIãŒæ–‡ç« ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...");
        this.generatedHistory.clear();
        await new Promise(r => setTimeout(r, 600));
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                this.lastWorkbook = workbook;
                this.renderTable(workbook);
                App.hideLoading();
                document.querySelector('#view-ai .drop-wrapper').style.display = 'none';
                document.getElementById('aiResultArea').classList.remove('hidden');
            } catch (err) {
                console.error(err);
                App.hideLoading();
                alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: Excelãƒ•ã‚¡ã‚¤ãƒ«ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        };
        reader.readAsArrayBuffer(file);
    },

    analyze(text) {
        text = (text || "").toString();
        let typeScores = { A:0, B:0, C:0, D:0 };
        Object.keys(this.KEYWORDS.types).forEach(t => {
            this.KEYWORDS.types[t].forEach(w => { if(text.includes(w)) typeScores[t]++; });
        });
        let type = Object.keys(typeScores).reduce((a, b) => typeScores[a] > typeScores[b] ? a : b);
        if(Object.values(typeScores).every(v => v === 0)) type = 'D';
        let posCount = 0, negCount = 0;
        this.KEYWORDS.sentiment.positive.forEach(w => { if(text.includes(w)) posCount++; });
        this.KEYWORDS.sentiment.negative.forEach(w => { if(text.includes(w)) negCount++; });
        const context = (posCount >= negCount * 1.5 || (posCount > 0 && negCount === 0)) ? 'high' : 'low';
        return { type, context };
    },

    getRandom(arr) { return (!arr || arr.length === 0) ? "" : arr[Math.floor(Math.random() * arr.length)]; },

    generate(analysis, category, slotKey = null, retryCount = 0) {
        const { type, context } = analysis;
        let text = "";
        const opener = this.getRandom(this.VOCAB.openers);
        const mod = this.getRandom(this.VOCAB.modifiers[context]);
        if (category === 'policy') {
            const template = this.getRandom(this.VOCAB.policy[context]);
            text = template.replace('{opener}', opener).replace('{mod}', mod).replace('{focus}', this.VOCAB.policy.focus[type]);
        } else if (category === 'long') {
            const template = this.getRandom(this.VOCAB.long_goal[context]);
            text = template.replace('{mod}', mod).replace('{focus}', this.VOCAB.long_goal.focus[type]);
        } else if (category === 'short') {
            const template = this.getRandom(this.VOCAB.short_goal[context]);
            text = template.replace('{mod}', mod);
        } else if (category === 'goal') {
            const topic = this.getRandom(this.VOCAB.contents[slotKey].topic);
            const end = this.getRandom(this.VOCAB.endings[`goal_${context}`]);
            text = (context === 'high') ? `${topic}ã‚’${mod}${end}` : `${mod}${topic}ã‚’${end}`;
        } else if (category === 'support') {
            const topic = this.getRandom(this.VOCAB.contents[slotKey].sup);
            const end = this.getRandom(this.VOCAB.endings[`sup_${context}`]);
            text = (context === 'high') ? `${topic}ã‚’é€šã˜ã¦ã€${mod}${end}` : `å¿…è¦ã«å¿œã˜${topic}ã‚’è¡Œã„ã€${mod}${end}`;
        }
        text = text.replace("  ", " ").trim();
        if (this.generatedHistory.has(text) && retryCount < 20) return this.generate(analysis, category, slotKey, retryCount + 1);
        this.generatedHistory.add(text);
        return text;
    },

    renderTable(workbook) {
        const tbody = document.querySelector('#aiResultTable tbody');
        tbody.innerHTML = '';
        this.generatedHistory.clear();
        this.currentGeneratedData = [];
        let count = 0;

        workbook.SheetNames.forEach(sheetName => {
            if (sheetName.match(/è¨­å®š|ãƒã‚¹ã‚¿|config|list|ä¸€è¦§|Sheet/i)) return;
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            const fullText = json.map(row => row.join(' ')).join(' ');
            const analysis = this.analyze(fullText);
            const policy = this.generate(analysis, 'policy');
            const longGoal = this.generate(analysis, 'long');
            const shortGoal = this.generate(analysis, 'short');
            const l_g = this.generate(analysis, 'goal', 'life'); const l_s = this.generate(analysis, 'support', 'life');
            const w_g = this.generate(analysis, 'goal', 'work'); const w_s = this.generate(analysis, 'support', 'work');
            const f_g = this.generate(analysis, 'goal', 'future'); const f_s = this.generate(analysis, 'support', 'future');
            
            this.currentGeneratedData.push({
                name: sheetName,
                policy, long_goal: longGoal, short_goal: shortGoal,
                life_goal: l_g, life_sup: l_s,
                work_goal: w_g, work_sup: w_s,
                future_goal: f_g, future_sup: f_s
            });

            const badgeClass = analysis.context === 'high' ? 'badge-high' : 'badge-low';
            const badgeText = analysis.context === 'high' ? 'å®‰å®šãƒ»è‰¯å¥½' : 'æ”¯æ´ãƒ»èª²é¡Œ';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:bold; color:var(--text-main);">${sheetName}</td>
                <td><div class="badge badge-${analysis.type}" style="margin-bottom:4px;">TYPE ${analysis.type}</div><br><div class="badge ${badgeClass}">${badgeText}</div></td>
                <td>${policy}</td><td>${longGoal}</td><td>${shortGoal}</td>
                <td class="col-life">${l_g}</td><td class="col-life">${l_s}</td>
                <td class="col-work">${w_g}</td><td class="col-work">${w_s}</td>
                <td class="col-future">${f_g}</td><td class="col-future">${f_s}</td>
            `;
            tbody.appendChild(tr);
            count++;
        });
        document.getElementById('aiCountDisplay').innerText = count;
    },

    copyToClipboard() {
        let txt = "";
        const headers = Array.from(document.querySelectorAll('#aiResultTable thead th')).map(th => th.innerText);
        txt += headers.join('\t') + '\n';
        document.querySelectorAll('#aiResultTable tbody tr').forEach(tr => {
            const tds = Array.from(tr.children).map(td => td.innerText.replace(/\n/g,' '));
            txt += tds.join('\t') + '\n';
        });
        navigator.clipboard.writeText(txt).then(() => Utils.showToast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"));
    },

    download() {
        let csv = "";
        const headers = Array.from(document.querySelectorAll('#aiResultTable thead th'))
            .filter((_, i) => i !== 1)
            .map(th => Utils.escapeCSV(th.innerText));
        csv += headers.join(',') + "\n";
        document.querySelectorAll('#aiResultTable tbody tr').forEach(tr => {
            const row = Array.from(tr.children)
                .filter((_, i) => i !== 1)
                .map(td => Utils.escapeCSV(td.innerText));
            csv += row.join(',') + "\n";
        });
        Utils.downloadCSV(`AIç”Ÿæˆæ¡ˆ_å¯å¤‰ãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().slice(0,10)}.csv`, csv);
    },

    downloadMergedCSV() {
        if (this.currentGeneratedData.length === 0) { alert("AIç”Ÿæˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«Excelã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚"); return; }
        const dbData = DBManager.getAll();
        const aiData = this.currentGeneratedData;
        const baseHeaders = DBManager.FORM_CONFIG.map(f => f.label);
        const extraHeaders = ["ç›®æ¨™1(ç”Ÿæ´»)", "æ”¯æ´1", "ç›®æ¨™2(ä½œæ¥­)", "æ”¯æ´2", "ç›®æ¨™3(å°±åŠ´)", "æ”¯æ´3"];
        const headerRow = [...baseHeaders, ...extraHeaders].map(h => Utils.escapeCSV(h)).join(",") + "\n";
        let csv = headerRow;

        aiData.forEach(aiRecord => {
            const dbRecord = dbData.find(d => d.name === aiRecord.name) || {};
            const rowData = [];
            DBManager.FORM_CONFIG.forEach(field => {
                let val = dbRecord[field.key] || "";
                if (field.key === 'policy' && aiRecord.policy) val = aiRecord.policy;
                if (field.type === 'date' && val) val = Utils.toJapaneseDate(val);
                if (field.key === 'name' && !val) val = aiRecord.name;
                rowData.push(Utils.escapeCSV(val));
            });
            rowData.push(Utils.escapeCSV(aiRecord.life_goal));
            rowData.push(Utils.escapeCSV(aiRecord.life_sup));
            rowData.push(Utils.escapeCSV(aiRecord.work_goal));
            rowData.push(Utils.escapeCSV(aiRecord.work_sup));
            rowData.push(Utils.escapeCSV(aiRecord.future_goal));
            rowData.push(Utils.escapeCSV(aiRecord.future_sup));
            csv += rowData.join(",") + "\n";
        });
        Utils.downloadCSV(`çµ±åˆ_æ”¯æ´è¨ˆç”»ãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().slice(0,10)}.csv`, csv);
    }
};

/**
 * DB MANAGER (Fixed Data)
 */
const DBManager = {
    DB_KEY: 'support_plan_db_v1',
    allMembers: [],
    FORM_CONFIG: [
        { label: "ID (è‡ªå‹•æ¡ç•ª)", type: "text", required: true, key: "id", readonly: true },
        { label: "åˆ©ç”¨è€…æ°å", type: "text", required: true, key: "name" },
        { label: "ãµã‚ŠãŒãª", type: "text", key: "kana" },
        { label: "æ€§åˆ¥", type: "select", options: ["ç”·æ€§", "å¥³æ€§", "ãã®ä»–"], key: "gender" },
        { label: "åˆ©ç”¨è€…ç”Ÿå¹´æœˆæ—¥", type: "date", key: "dob" },
        { label: "éšœå®³åŒºåˆ†", type: "select", options: ["èº«ä½“", "çŸ¥çš„", "ç²¾ç¥"], key: "disability_type" },
        { label: "å€‹åˆ¥æ”¯æ´è¨ˆç”»æ›¸ä½œæˆæ—¥", type: "date", key: "plan_date" },
        { label: "å‰å›ä½œæˆæ—¥", type: "date", key: "prev_plan_date" },
        { label: "æ”¯æ´æä¾›æ—¥ã¯ã˜ã‚", type: "date", key: "support_start" },
        { label: "æ”¯æ´æä¾›æ—¥ãŠã‚ã‚Š", type: "date", key: "support_end" },
        { label: "ç‰¹è¨˜äº‹é …", type: "textarea", key: "notes" },
        { label: "å°±åŠ´ç¶™ç¶šæ”¯æ´Aå‹åˆ©ç”¨ã¾ã§ã®çµŒç·¯", type: "textarea", key: "history" },
        { label: "æœ¬äººã®å¸Œæœ›ï¼ˆæ¥­å‹™å†…å®¹ã€è³ƒé‡‘ï¼‰", type: "textarea", key: "hopes" },
        { label: "å¹´é‡‘ã®æœ‰ç„¡ã€åå…¥çŠ¶æ³", type: "textarea", key: "income" },
        { label: "ç”Ÿç”£æ´»å‹•æ™‚ã®èª²é¡Œ", type: "textarea", key: "issues" },
        { label: "å¥åº·çŠ¶æ…‹ï¼ˆç—…åã€æœè–¬çŠ¶æ³ï¼‰", type: "textarea", key: "health" },
        { label: "ç•™æ„ã™ã‚‹åŒ»å­¦çš„ãƒªã‚¹ã‚¯", type: "textarea", key: "medical_risk" },
        { label: "æœ¬äººã®ç”Ÿæ´»çŠ¶æ³", type: "textarea", key: "lifestyle" },
        { label: "ç·åˆçš„ãªæ”¯æ´ã®æ–¹é‡", type: "textarea", key: "policy" },
        { label: "é•·æœŸç›®æ¨™è¨­å®šæ—¥", type: "date", key: "long_goal_date" },
        { label: "é•·æœŸç›®æ¨™é”æˆäºˆå®šæ—¥", type: "date", key: "long_goal_due" },
        { label: "çŸ­æœŸç›®æ¨™è¨­å®šæ—¥", type: "date", key: "short_goal_date" },
        { label: "çŸ­æœŸç›®æ¨™é”æˆäºˆå®šæ—¥", type: "date", key: "short_goal_due" },
        { label: "è¨ˆç”»ä½œæˆè€…", type: "text", value: "åœŸå²å€‰", key: "creator" },
        { label: "ç®¡ç†è€…â‘ ", type: "text", value: "å¥ˆè‰¯", key: "manager1" },
        { label: "ç®¡ç†è€…â‘¡", type: "text", value: "ä¸­è¾¼", key: "manager2" },
        { label: "ã‚µãƒ“ç®¡â‘ ", type: "text", value: "å¥ˆè‰¯", key: "svc_manager1" },
        { label: "ã‚µãƒ“ç®¡â‘¡", type: "text", value: "åœŸå²å€‰", key: "svc_manager2" },
        { label: "è·æ¥­æŒ‡å°å“¡â‘ ", type: "text", value: "ä¸­å±±", key: "instructor1" },
        { label: "è·æ¥­æŒ‡å°å“¡â‘¡", type: "text", value: "æº€å°¾", key: "instructor2" },
        { label: "ç”Ÿæ´»æ”¯æ´å“¡â‘ ", type: "text", value: "æ›½çˆ¾", key: "supporter1" },
        { label: "ç”Ÿæ´»æ”¯æ´å“¡â‘¡", type: "text", value: "é‡‘å±±", key: "supporter2" }
    ],

    init() {
        this.generateForm();
        this.loadData();
        const dropZone = document.getElementById('dropZoneDB');
        const fileInput = document.getElementById('fileInputDB');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            dropZone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
        });
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => this.handleDrop(e));
        fileInput.addEventListener('change', (e) => { if(e.target.files[0]) this.handleFile(e.target.files[0]); });
    },

    getAll() {
        try {
            const json = localStorage.getItem(this.DB_KEY);
            return json ? JSON.parse(json) : [];
        } catch (e) { console.error(e); return []; }
    },

    save(record, forceInsert = false) {
        try {
            const allData = this.getAll();
            if (forceInsert) {
                allData.push(record);
            } else {
                const index = allData.findIndex(r => String(r.id) === String(record.id));
                if (index > -1) allData[index] = record; else allData.push(record);
            }
            localStorage.setItem(this.DB_KEY, JSON.stringify(allData));
            // Saveå¾Œã«ã‚¢ãƒ©ãƒ¼ãƒˆå†ãƒã‚§ãƒƒã‚¯
            setTimeout(() => AlertManager.checkDeadlines(this.getAll()), 500);
            return true;
        } catch (e) { alert("å®¹é‡ã‚ªãƒ¼ãƒãƒ¼ç­‰ã®ç†ç”±ã§ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"); return false; }
    },

    getNextId() {
        const allData = this.getAll();
        if (allData.length === 0) return 1;
        const ids = allData.map(d => parseInt(d.id)).filter(n => !isNaN(n));
        return ids.length > 0 ? Math.max(...ids) + 1 : 1;
    },

    getById(id) { return this.getAll().find(r => String(r.id) === String(id)); },

    loadData() {
        this.allMembers = this.getAll();
        this.renderList(this.allMembers);
        // Loadå¾Œã«ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
        AlertManager.checkDeadlines(this.allMembers);
    },

    renderList(data) {
        const container = document.getElementById("db-list-container");
        if (data.length === 0) {
            container.innerHTML = `<div style="padding:40px; text-align:center; color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>å³ä¸‹ã®ï¼‹ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã€ã¾ãŸã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã£ã¦ä¸€æ‹¬ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>`;
            return;
        }
        const sortedData = [...data].sort((a, b) => parseInt(b.id) - parseInt(a.id));
        let html = "";
        sortedData.forEach(row => {
            html += `<div class="list-item">
                <div class="list-content" onclick="DBManager.editMember('${row.id}')">
                    <div style="display:flex; align-items:center;">
                        <span class="list-id-badge">${row.id}</span>
                        <div>
                            <span class="list-name">${row.name || '(åç§°æœªè¨­å®š)'}</span>
                            <span class="list-meta">${row.disability_type || ''} ${row.dob ? '(' + Utils.toJapaneseDate(row.dob) + 'ç”Ÿ)' : ''}</span>
                        </div>
                    </div>
                </div>
                <div class="action-area">
                    <button class="btn-delete" title="å‰Šé™¤" onclick="DBManager.deleteMember('${row.id}', '${row.name}')">ğŸ—‘ï¸</button>
                    <div style="color:#ccc; cursor:pointer;" onclick="DBManager.editMember('${row.id}')">â€º</div>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    },

    deleteMember(id, name) {
        if(!confirm(`ã€Œ${name || id}ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        try {
            let allData = this.getAll();
            allData = allData.filter(r => String(r.id) !== String(id));
            localStorage.setItem(this.DB_KEY, JSON.stringify(allData));
            Utils.showToast("å‰Šé™¤ã—ã¾ã—ãŸ", "success");
            this.loadData();
        } catch(e) { Utils.showToast("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ", "error"); }
    },

    deleteAll() {
        if(this.allMembers.length === 0) return;
        if(!confirm("âš ï¸ æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return;
        try {
            localStorage.removeItem(this.DB_KEY);
            this.loadData();
            Utils.showToast("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ", "success");
        } catch(e) { Utils.showToast("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ", "error"); }
    },

    filterList() {
        const keyword = document.getElementById("dbSearchInput").value.toLowerCase();
        if (!keyword) { this.renderList(this.allMembers); return; }
        const filtered = this.allMembers.filter(row => {
            return String(row.id).includes(keyword) || String(row.name).toLowerCase().includes(keyword) || String(row.kana).toLowerCase().includes(keyword);
        });
        this.renderList(filtered);
    },

    handleDrop(e) {
        document.getElementById('dropZoneDB').classList.remove('dragover');
        if (e.dataTransfer.files[0]) this.handleFile(e.dataTransfer.files[0]);
    },

    async handleFile(file) {
        App.showLoading("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æã—ã¦å°å¸³ã«ç™»éŒ²ä¸­...");
        await new Promise(r => setTimeout(r, 500));
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                let count = 0;
                if (jsonData.length > 1 && jsonData[0].includes("åˆ©ç”¨è€…æ°å")) {
                    count = this.importCSVList(jsonData);
                } else {
                    count = this.importWorkbook(workbook);
                }
                App.hideLoading();
                Utils.showToast(`${count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`, "success");
                this.loadData();
            } catch (err) {
                console.error(err);
                App.hideLoading();
                alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        };
        reader.readAsArrayBuffer(file);
    },

    importWorkbook(workbook) {
        let count = 0;
        let currentMaxId = this.getNextId();
        workbook.SheetNames.forEach(sheetName => {
            if (sheetName.match(/è¨­å®š|ãƒã‚¹ã‚¿|config|list|ä¸€è¦§|Sheet/i)) return;
            const sheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            const record = { id: currentMaxId.toString() };
            currentMaxId++;
            this.FORM_CONFIG.forEach(field => {
                if (field.key === 'id') return;
                let foundValue = "";
                for (let r = 0; r < data.length; r++) {
                    const row = data[r];
                    for (let c = 0; c < row.length; c++) {
                        const cellVal = String(row[c] || "").trim();
                        if (cellVal.indexOf(field.label) > -1) {
                            if (c + 1 < row.length && row[c+1]) foundValue = row[c+1];
                            else if (r + 1 < data.length && data[r+1][c]) foundValue = data[r+1][c];
                            break;
                        }
                    }
                    if (foundValue) break;
                }
                if (foundValue) record[field.key] = foundValue;
            });
            if (!record.name) record.name = sheetName;
            this.save(record, true);
            count++;
        });
        return count;
    },

    importCSVList(data) {
        let count = 0;
        let currentMaxId = this.getNextId();
        const headers = data[0]; 
        const keyMap = {};
        this.FORM_CONFIG.forEach(f => {
            const idx = headers.indexOf(f.label);
            if (idx > -1) keyMap[f.key] = idx;
        });

        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            if (!row || row.length === 0) continue;
            let id = row[keyMap['id']];
            let isNew = false;
            if (!id) { id = currentMaxId.toString(); isNew = true; currentMaxId++; }
            const record = { id: String(id) };
            Object.keys(keyMap).forEach(key => {
                const idx = keyMap[key];
                if (row[idx] !== undefined) record[key] = row[idx];
            });
            if (!record.name) record.name = "åç§°æœªè¨­å®š";
            this.save(record, isNew);
            count++;
        }
        return count;
    },

    generateForm() {
        const container = document.getElementById("dynamic-form-fields");
        let html = "";
        this.FORM_CONFIG.forEach((field, index) => {
            const inputId = `field_${index}`;
            const cssClass = field.value ? "fixed-value" : "";
            const reqClass = field.required ? "required" : "";
            const readonlyAttr = field.readonly ? "readonly" : "";
            let inputHtml = "";
            if (field.type === "textarea") inputHtml = `<textarea id="${inputId}" class="${cssClass}" ${readonlyAttr} ${field.required ? 'required' : ''}></textarea>`;
            else if (field.type === "select") {
                let options = `<option value="">é¸æŠã—ã¦ãã ã•ã„</option>`;
                if (field.options) options += field.options.map(opt => `<option value="${opt}">${opt}</option>`).join("");
                inputHtml = `<select id="${inputId}" class="${cssClass}" ${field.required ? 'required' : ''}>${options}</select>`;
            } else inputHtml = `<input type="${field.type}" id="${inputId}" class="${cssClass}" ${readonlyAttr} ${field.required ? 'required' : ''}>`;
            html += `<div class="form-group"><label class="${reqClass}">${field.label}</label>${inputHtml}</div>`;
        });
        container.innerHTML = html;
    },

    openForm() {
        document.getElementById("dbForm").reset();
        this.FORM_CONFIG.forEach((field, index) => {
            const el = document.getElementById(`field_${index}`);
            if (field.value && el) el.value = field.value;
        });
        const idEl = document.getElementById("field_0");
        if (idEl) idEl.value = this.getNextId();
        document.getElementById("formModal").classList.add("active");
    },

    closeForm() { document.getElementById("formModal").classList.remove("active"); },

    editMember(id) {
        const record = this.getById(id);
        if (!record) return;
        this.FORM_CONFIG.forEach((field, index) => {
            const el = document.getElementById(`field_${index}`);
            if (el) {
                const val = record[field.key];
                el.value = val !== undefined ? val : (field.value || "");
            }
        });
        document.getElementById("formModal").classList.add("active");
    },

    saveForm() {
        const record = {};
        this.FORM_CONFIG.forEach((field, index) => {
            const el = document.getElementById(`field_${index}`);
            if (el) record[field.key] = el.value;
        });
        if (!record.name) { alert("åˆ©ç”¨è€…æ°åã¯å¿…é ˆã§ã™"); return; }
        if (this.save(record)) {
            Utils.showToast("ä¿å­˜ã—ã¾ã—ãŸ");
            this.loadData();
            this.closeForm();
        }
    },

    exportCSV() {
        if (this.allMembers.length === 0) { alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
        let csv = this.FORM_CONFIG.map(f => Utils.escapeCSV(f.label)).join(",") + "\r\n";
        this.allMembers.forEach(record => {
            const row = this.FORM_CONFIG.map(field => {
                let val = record[field.key];
                if (field.type === 'date' && val) val = Utils.toJapaneseDate(val);
                return Utils.escapeCSV(val);
            });
            csv += row.join(",") + "\r\n";
        });
        Utils.downloadCSV(`å°å¸³ãƒ‡ãƒ¼ã‚¿_å›ºå®š_${new Date().toISOString().slice(0,10)}.csv`, csv);
    },

    downloadTemplate() {
        let csvContent = "";
        const headers = this.FORM_CONFIG.map(f => Utils.escapeCSV(f.label)).join(",");
        csvContent += headers + "\r\n";
        if (this.allMembers.length > 0) {
            this.allMembers.forEach(record => {
                const row = this.FORM_CONFIG.map(field => {
                    let val = record[field.key];
                    return Utils.escapeCSV(val);
                });
                csvContent += row.join(",") + "\r\n";
            });
            Utils.downloadCSV("å°å¸³ãƒ‡ãƒ¼ã‚¿ç·¨é›†ç”¨.csv", csvContent);
        } else {
            Utils.downloadCSV("æ–°è¦ç™»éŒ²ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.csv", csvContent);
        }
    }
};

/**
 * MAIN CONTROLLER
 */
const App = {
    init() {
        AIEngine.init();
        DBManager.init();
    },
    switchMode(mode) {
        document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.mode-tab[data-mode="${mode}"]`).classList.add('active');
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.getElementById(`view-${mode}`).classList.add('active');
    },
    showLoading(text) {
        document.getElementById('loadingText').innerText = text;
        document.getElementById('loadingOverlay').classList.add('active');
    },
    hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
    }
};

document.addEventListener('DOMContentLoaded', () => App.init());

</script>
</body>
</html>